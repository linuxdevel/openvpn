# Raspberry Pi/Linux OpenVPN Server in Bridge Mode

This guide provides step-by-step instructions to set up an OpenVPN server in bridge mode on a Raspberry Pi or Linux device. Bridged networking allows VPN clients to appear as if they are on the same local network as the server, enabling seamless communication.

## Prerequisites

1. **Static IP Address**: Ensure your Raspberry Pi has a static IP address. This can be configured:
   - Directly on the Raspberry Pi using `raspi-config`.
   - By reserving an IP address for the Raspberry Pi in your router's DHCP settings.

2. **Bridge Utilities**: Install `bridge-utils` for managing network bridges.

3. **OpenVPN**: Install and configure OpenVPN using the provided script.

---

## Why Bridge Mode?

Bridge mode is particularly useful for applications like ham radio (e.g., ExpertSDR3), where devices need to communicate as if they are on the same local network. Unlike routed mode, bridge mode allows broadcast and multicast traffic, which is essential for some applications.

---

## Step 1: Install Raspberry Pi OS

Follow the instructions on [RaspberryTips](https://raspberrytips.com/install-raspberry-pi-os/) to install Raspberry Pi OS on your device's memory card.

---

## Step 2: Configure Raspberry Pi

1. **Log in to Your Raspberry Pi**  
   Follow the guide on [Raspberry Pi Guide](https://raspberrypi-guide.github.io/getting-started/raspberry-pi-configuration) to access your Raspberry Pi.

2. **Disable GUI Mode (Optional)**  
   If the Raspberry Pi will only be used as an OpenVPN server, disable the GUI to save resources:
   - Run `sudo raspi-config`.
   - Navigate to `System Options > Boot / Auto Login > Console`.

3. **Enable SSH Access (Optional)**  
   To enable remote command-line access:
   - In `raspi-config`, go to `Interface Options > SSH` and enable it.

4. **Change Default Password**  
   Use a strong password for the `pi` user:
   ```bash
   passwd
   ```

5. **Reboot the Device**  
   ```bash
   sudo reboot -h now
   ```

---

## Step 3: Enable Automatic Updates

To keep your Raspberry Pi secure, enable automatic updates. Follow one of these guides:
- [Zeal for Technology](https://www.zealfortechnology.com/2018/08/configure-unattended-upgrades-on-raspberry-pi.html)
- [Sean Carney's Guide](https://www.seancarney.ca/2021/02/06/secure-your-raspberry-pi-by-enabling-automatic-software-updates/)

---

## Step 4: Install Bridge Utilities

Install the `bridge-utils` package:
```bash
sudo apt install bridge-utils
```

---

## Step 5: Install OpenVPN

1. Download the OpenVPN installation script:
   ```bash
   curl -O https://raw.githubusercontent.com/angristan/openvpn-install/master/openvpn-install.sh
   ```

2. Make the script executable:
   ```bash
   chmod +x openvpn-install.sh
   ```

3. Run the script:
   ```bash
   sudo ./openvpn-install.sh
   ```
   - Follow the prompts to configure OpenVPN. If unsure, use the default options.
   - Select an elliptic curve key (e.g., P-521) for better security.

---

## Step 6: Configure OpenVPN for Bridge Mode

1. Edit the `server.conf` file:
   ```bash
   sudo nano /etc/openvpn/server.conf
   ```

2. Change the following lines:
   - Replace `dev tun` with:
     ```conf
     dev tap0
     ```
   - Replace the `server` line with:
     ```conf
     server-bridge <RPI_IP> <NETMASK> <START_IP> <END_IP>
     ```
     Example:
     ```conf
     server-bridge 192.168.1.134 255.255.255.0 192.168.1.200 192.168.1.210
     ```

3. Ensure the IP range for VPN clients does not overlap with your DHCP server's range.

---

## Step 7: Configure the Bridge Script

1. Copy the `bridge_start.sh` script to `/etc/openvpn`:
   ```bash
   sudo cp bridge_start.sh /etc/openvpn/
   ```

2. Make it executable:
   ```bash
   chmod +x /etc/openvpn/bridge_start.sh
   ```

3. Edit the script to match your network settings:
   - Update `eth_ip`, `eth_netmask`, `eth_broadcast`, `eth_gateway`, and `eth_mac` to match your Raspberry Pi's network configuration.
   - Use `ifconfig` to find these values:
     ```bash
     ifconfig
     ```

---

## Step 8: Enable Auto Startup of the Bridge Script

Edit `/etc/rc.local` and add the following line before `exit 0`:
```bash
sudo /etc/openvpn/bridge_start.sh
```

---

## Step 9: Configure the Client

1. Edit the `client.ovpn` file generated by the OpenVPN installation script:
   - Replace `dev tun` with:
     ```conf
     dev tap
     ```
   - Update the `remote` line with your public IP or dynamic DNS hostname.

2. Import the `client.ovpn` file into your OpenVPN client application.

---

## Step 10: Configure Router Port Forwarding

Forward the OpenVPN port (default: UDP 1194) from your router to your Raspberry Pi. For better security, consider using a non-standard port (e.g., 21194).

---

## Troubleshooting

### Subnet Conflicts
If your local network and the VPN network use the same subnet (e.g., both use `192.168.1.x`), the VPN will not work. To avoid this:
- Use a unique private IP range for your VPN, such as `10.11.12.0/24`.

---

## Useful Links

- [OpenVPN TAP Bridge Mode](https://www.aaflalo.me/2015/01/openvpn-tap-bridge-mode/)
- [OpenVPN Ethernet Bridging](https://openvpn.net/community-resources/ethernet-bridging/)
- [Dynamic DNS Services](https://www.noip.com) | [CloudNS](https://www.cloudns.net)
- [Set Static IP on Raspberry Pi](https://raspberrytips.com/set-static-ip-address-raspberry-pi/)

---

## Final Thoughts

Bridge mode is a powerful way to extend your local network over a VPN. However, it requires careful configuration to avoid conflicts and ensure security. By following this guide, you can set up a robust OpenVPN server tailored to your needs.

